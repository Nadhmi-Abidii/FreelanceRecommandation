<!-- NAVBAR (m√™me style que dashboard admin) -->
<mat-toolbar class="topbar" role="navigation" aria-label="Navigation administrateur">
  <div class="brand" routerLink="/admin" routerLinkActive="active" aria-label="ToWork dashboard">
    <svg class="logo-svg" width="34" height="34" viewBox="0 0 48 48" role="img" aria-label="ToWork logo">
      <defs>
        <linearGradient id="twg-admin" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#2563eb" />
          <stop offset="100%" stop-color="#7c3aed" />
        </linearGradient>
      </defs>
      <rect x="2" y="2" width="44" height="44" rx="12" fill="url(#twg-admin)" />
      <path
        d="M14 18h20a2 2 0 0 0 0-4H14a2 2 0 0 0 0 4zm8 2v14a2 2 0 0 0 4 0V20z"
        fill="white" />
    </svg>
    <span class="brand-name">ToWork</span>
  </div>

  <nav class="nav" aria-label="Sections administrateur">
    <a mat-button routerLink="/admin" routerLinkActive="active">
      <mat-icon>dashboard</mat-icon>
      Tableau de bord
    </a>
    <a mat-button routerLink="/admin/users" routerLinkActive="active">
      <mat-icon>group</mat-icon>
      Utilisateurs
    </a>
    <a mat-button routerLink="/admin/domaines" routerLinkActive="active">
      <mat-icon>category</mat-icon>
      Domaines & comp√©tences
    </a>
  </nav>

  <span class="spacer"></span>

  <button mat-icon-button [matMenuTriggerFor]="adminMenu" aria-label="Ouvrir le menu administrateur">
    <mat-icon>shield_person</mat-icon>
  </button>
  <mat-menu #adminMenu="matMenu">
    <button mat-menu-item disabled>
      <mat-icon>person</mat-icon>
      {{ adminName() }}
    </button>
    <mat-divider></mat-divider>
     <button mat-menu-item (click)="logout()">
    <mat-icon>logout</mat-icon>
    <span>D√©connexion</span>
  </button>
  </mat-menu>
</mat-toolbar>

<!-- HERO -->
<section class="hero domain-hero">
  <div class="hero__content">
    <p class="eyebrow">Catalogue</p>
    <h1>Domaines d'expertise & comp√©tences</h1>
    <p class="subtitle">
      Bonjour, {{ adminName() }} ‚Äî g√©rez les domaines et le catalogue de comp√©tences de la plateforme.
    </p>
  </div>
  <button
    mat-raised-button
    color="primary"
    class="hero__cta"
    type="button"
    (click)="cancelEditDomain()">
    <mat-icon>add_circle</mat-icon>
    Nouveau domaine
  </button>
</section>

<!-- STATS -->
<div class="domain-stats">
  <mat-card class="panel domain-stat">
    <div class="domain-stat__icon" aria-hidden="true">
      <mat-icon>category</mat-icon>
    </div>
    <div class="domain-stat__content">
      <span class="domain-stat__label">Domaines actifs</span>
      <span class="domain-stat__value">{{ totalDomains() }}</span>
    </div>
  </mat-card>

  <mat-card class="panel domain-stat">
    <div class="domain-stat__icon" aria-hidden="true">
      <mat-icon>stars</mat-icon>
    </div>
    <div class="domain-stat__content">
      <span class="domain-stat__label">Comp√©tences r√©f√©renc√©es</span>
      <span class="domain-stat__value">{{ totalDomainSkills() }}</span>
    </div>
  </mat-card>

  <mat-card class="panel domain-stat">
    <div class="domain-stat__icon" aria-hidden="true">
      <mat-icon>trending_up</mat-icon>
    </div>
    <div class="domain-stat__content">
      <span class="domain-stat__label">Top domaine</span>
      <span class="domain-stat__value domain-stat__value--text">
        {{ topDomainLabel() }}
      </span>
    </div>
  </mat-card>
</div>

<!-- DOMAINES -->
<section class="domains" aria-labelledby="domains-title">
  <header class="domains__header">
    <div>
      <h2 id="domains-title">
        {{ isEditingDomain() ? 'Modifier un domaine' : 'Ajouter un domaine' }}
      </h2>
      <p>
        {{
          isEditingDomain()
            ? 'Mettez √† jour le nom et la description du domaine s√©lectionn√©.'
            : 'D√©clarez un nouveau domaine et organisez vos missions par th√©matiques.'
        }}
      </p>
    </div>
    <button
      mat-stroked-button
      color="primary"
      type="button"
      (click)="cancelEditDomain()"
      *ngIf="isEditingDomain()">
      <mat-icon>refresh</mat-icon>
      Annuler
    </button>
  </header>

  <div class="domains__grid">
    <!-- FORM DOMAINE (SANS COMP√âTENCES ASSOCI√âES) -->
    <mat-card class="panel domain-form">
      <form
        class="domain-form__form"
        [formGroup]="domainForm"
        (ngSubmit)="submitDomain()"
        autocomplete="off">

        <mat-form-field appearance="outline">
          <mat-label>Nom du domaine</mat-label>
          <input matInput formControlName="name" required maxlength="60" />
          <mat-hint align="end">
            {{ domainNameControl.value.length }}/60
          </mat-hint>
          <mat-error *ngIf="domainNameControl.hasError('required')">
            Le nom du domaine est requis.
          </mat-error>
          <mat-error *ngIf="domainNameControl.hasError('maxlength')">
            60&nbsp;caract√®res maximum.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            rows="3"
            maxlength="160">
          </textarea>
          <mat-hint align="end">
            {{ domainDescriptionControl.value.length }}/160
          </mat-hint>
        </mat-form-field>

        <div class="domain-form__actions">
          <button mat-stroked-button type="button" (click)="cancelEditDomain()">
            R√©initialiser
          </button>
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="domainForm.invalid">
            <mat-icon>
              {{ isEditingDomain() ? 'save' : 'add_circle' }}
            </mat-icon>
            {{ isEditingDomain() ? 'Mettre √† jour' : 'Ajouter le domaine' }}
          </button>
        </div>
      </form>
    </mat-card>

    <!-- TABLE + D√âTAIL DOMAINES -->
    <div class="domains__right">
      <mat-card class="panel domain-table">
        <header class="panel__header">
          <div>
            <h2>Domaines enregistr√©s</h2>
            <p>
              Recherchez, modifiez, (d√©s)activez ou supprimez les domaines
              existants.
            </p>
          </div>

          <mat-form-field appearance="outline" class="domain-table__search">
            <mat-label>Rechercher un domaine</mat-label>
            <mat-icon matPrefix>search</mat-icon>
            <input
              matInput
              type="search"
              [value]="domainSearch()"
              (input)="setDomainSearch(($any($event.target).value || '').toString())"
              placeholder="Nom du domaine" />
            <button
              mat-icon-button
              matSuffix
              type="button"
              aria-label="Effacer"
              *ngIf="domainSearch()"
              (click)="clearDomainSearch()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </header>

        <div class="table-wrapper" role="region" aria-label="Table des domaines">
          <div class="flex items-center justify-center p-4" *ngIf="loading()">
            <mat-progress-spinner
              mode="indeterminate"
              diameter="28">
            </mat-progress-spinner>
          </div>

          <table *ngIf="!loading()">
            <thead>
            <tr>
              <th scope="col">Domaine</th>
              <th scope="col">Nombre de comp√©tences</th>
              <th scope="col">Statut</th>
              <th scope="col" class="actions-col">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr
              *ngFor="let domain of domains(); trackBy: trackDomain"
              (click)="selectDomain(domain)"
              [class.is-selected]="selectedDomainId() === domain.id">
              <!-- Nom + description -->
              <td>
                <div class="domain-table__info">
                  <span class="domain-table__name">{{ domain.name }}</span>
                  <span class="domain-table__desc">
                    {{ domain.description || 'Aucune description' }}
                  </span>
                </div>
              </td>

              <!-- Nombre de comp√©tences -->
              <td>
                <span class="badge">
                  {{ ($any(domain).skills?.length || 0) }} comp√©tences
                </span>
              </td>

              <!-- Statut -->
              <td>
                <span
                  class="badge"
                  [class.badge--success]="domain.isActive"
                  [class.badge--muted]="!domain.isActive">
                  <mat-icon>
                    {{ domain.isActive ? 'check_circle' : 'pause_circle' }}
                  </mat-icon>
                  {{ domain.isActive ? 'Actif' : 'Inactif' }}
                </span>
              </td>

              <!-- Actions -->
              <td class="actions-col">
                <button
                  mat-icon-button
                  color="primary"
                  type="button"
                  aria-label="Modifier"
                  (click)="editDomain(domain); $event.stopPropagation()">
                  <mat-icon>edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  [color]="domain.isActive ? 'warn' : 'primary'"
                  type="button"
                  (click)="toggleActive(domain); $event.stopPropagation()"
                  [attr.aria-label]="domain.isActive ? 'D√©sactiver' : 'Activer'">
                  <mat-icon>
                    {{ domain.isActive ? 'toggle_off' : 'toggle_on' }}
                  </mat-icon>
                </button>

                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  aria-label="Supprimer"
                  (click)="deleteDomain(domain); $event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>

            <tr *ngIf="!loading() && domains().length === 0">
              <td colspan="4" class="empty-state">
                <mat-icon>sentiment_dissatisfied</mat-icon>
                <p>Aucun domaine ne correspond √† votre recherche.</p>
                <small>
                  Essayez un autre mot-cl√© ou ajoutez un nouveau domaine.
                </small>
              </td>
            </tr>
            </tbody>
          </table>

          <mat-paginator
            [length]="total()"
            [pageIndex]="pageIndex()"
            [pageSize]="pageSize()"
            [pageSizeOptions]="[5, 10, 20, 50]"
            (page)="pageChanged($event)">
          </mat-paginator>
        </div>
      </mat-card>

      <mat-card class="panel domain-detail" *ngIf="selectedDomain() as domain">
        <header class="panel__header">
          <div>
            <h2>{{ domain.name }}</h2>
            <p>
              {{
                domain.description ||
                'Aucune description renseign√©e pour ce domaine.'
              }}
            </p>
          </div>
          <button
            mat-icon-button
            color="primary"
            type="button"
            aria-label="Modifier ce domaine"
            (click)="editDomain(domain)">
            <mat-icon>edit</mat-icon>
          </button>
        </header>

        <div class="domain-detail__body">
          <p class="domain-detail__meta">
            Cr√©√© le {{ formatDomainDate(domain.createdAt) }}
            <span *ngIf="domain.updatedAt">
              ¬∑ Mis √† jour le {{ formatDomainDate(domain.updatedAt) }}
            </span>
          </p>

          <!-- Affiche skills si pr√©sents (champ optionnel c√¥t√© back) -->
          <div
            class="domain-detail__skills"
            *ngIf="($any(domain).skills?.length || 0) > 0">
            <span
              class="domain-skill-chip"
              *ngFor="let skill of ($any(domain).skills || []); trackBy: trackSkill">
              <mat-icon>verified</mat-icon>
              {{ skill }}
            </span>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</section>

<!-- COMP√âTENCES -->
<section class="domains domains--competences" aria-labelledby="competences-title">
  <header class="domains__header">
    <div>
      <h2 id="competences-title">
        {{ isEditingCompetence() ? 'Modifier une comp√©tence' : 'Ajouter une comp√©tence' }}
      </h2>
      <p>
        {{
          isEditingCompetence()
            ? 'Mettez √† jour le nom, la description ou le niveau de la comp√©tence s√©lectionn√©e.'
            : 'G√©rez le catalogue des comp√©tences disponibles pour les missions.'
        }}
      </p>
    </div>
    <button
      mat-stroked-button
      color="primary"
      type="button"
      (click)="cancelEditCompetence()"
      *ngIf="isEditingCompetence()">
      <mat-icon>refresh</mat-icon>
      Annuler
    </button>
  </header>

  <div class="domains__grid">
    <!-- FORMULAIRE COMP√âTENCE -->
    <mat-card class="panel domain-form">
      <form
        class="domain-form__form"
        [formGroup]="competenceForm"
        (ngSubmit)="submitCompetence()"
        autocomplete="off">

        <!-- üîΩ S√©lection du domaine -->
        <mat-form-field appearance="outline">
          <mat-label>Domaine</mat-label>
          <mat-select formControlName="domaineId" required>
            <mat-option [value]="0">S√©lectionner un domaine</mat-option>
            <mat-option
              *ngFor="let d of activeDomains(); trackBy: trackDomain"
              [value]="d.id">
              {{ d.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="competenceDomainControl.hasError('required') || competenceDomainControl.hasError('min')">
            Le domaine est requis.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Nom de la comp√©tence</mat-label>
          <input matInput formControlName="name" required maxlength="80" />
          <mat-hint align="end">
            {{ competenceNameControl.value.length }}/80
          </mat-hint>
          <mat-error *ngIf="competenceNameControl.hasError('required')">
            Le nom de la comp√©tence est requis.
          </mat-error>
          <mat-error *ngIf="competenceNameControl.hasError('maxlength')">
            80&nbsp;caract√®res maximum.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            rows="3"
            maxlength="200">
          </textarea>
          <mat-hint align="end">
            {{ competenceDescriptionControl.value.length }}/200
          </mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Niveau</mat-label>
          <mat-select formControlName="level">
            <mat-option value="">Non sp√©cifi√©</mat-option>
            <mat-option
              *ngFor="let lvl of competenceLevels"
              [value]="lvl">
              {{ formatCompetenceLevel(lvl) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- (Optionnel) ann√©es d'exp√©rience, si tu veux l'utiliser
        <mat-form-field appearance="outline">
          <mat-label>Ann√©es d'exp√©rience</mat-label>
          <input
            matInput
            type="number"
            formControlName="yearsOfExperience"
            min="0"
            max="60" />
          <mat-hint>Optionnel</mat-hint>
        </mat-form-field>
        -->

        <div class="domain-form__actions">
          <button mat-stroked-button type="button" (click)="cancelEditCompetence()">
            R√©initialiser
          </button>
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="competenceForm.invalid || competenceLoading()">
            <mat-icon>
              {{ isEditingCompetence() ? 'save' : 'add_circle' }}
            </mat-icon>
            {{ isEditingCompetence() ? 'Mettre √† jour' : 'Ajouter la comp√©tence' }}
          </button>
        </div>
      </form>
    </mat-card>

    <!-- TABLEAU + D√âTAIL DES COMP√âTENCES -->
    <div class="domains__right">
      <mat-card class="panel domain-table">
        <header class="panel__header">
          <div>
            <h2>Comp√©tences enregistr√©es</h2>
            <p>Liste des comp√©tences disponibles pour les missions.</p>
          </div>
        </header>

        <div class="table-wrapper" role="region" aria-label="Table des comp√©tences">
          <div class="flex items-center justify-center p-4" *ngIf="competenceLoading()">
            <mat-progress-spinner
              mode="indeterminate"
              diameter="28">
            </mat-progress-spinner>
          </div>

          <table *ngIf="!competenceLoading()">
            <thead>
            <tr>
              <th scope="col">Comp√©tence</th>
              <th scope="col">Niveau</th>
              <th scope="col">Exp√©rience</th>
              <th scope="col">Statut</th>
              <th scope="col" class="actions-col">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr
              *ngFor="let competence of competences(); trackBy: trackCompetence"
              (click)="selectCompetence(competence)"
              [class.is-selected]="selectedCompetence()?.id === competence.id">
              <td>
                <div class="domain-table__info">
                  <span class="domain-table__name">
                    {{ competence.name }}
                  </span>
                  <span class="domain-table__desc">
                    {{ competence.description || 'Aucune description' }}
                  </span>
                </div>
              </td>

              <td>
                <span class="join-date">
                  {{ formatCompetenceLevel(competence.level) }}
                </span>
              </td>

              <td>
                <span
                  class="join-date"
                  *ngIf="competence.yearsOfExperience != null; else noExp">
                  {{ competence.yearsOfExperience }}&nbsp;ans
                </span>
                <ng-template #noExp>‚Äî</ng-template>
              </td>

              <!-- Statut comp√©tence -->
              <td>
                <span
                  class="badge"
                  [class.badge--success]="competence.isActive"
                  [class.badge--muted]="!competence.isActive">
                  <mat-icon>
                    {{ competence.isActive ? 'check_circle' : 'pause_circle' }}
                  </mat-icon>
                  {{ competence.isActive ? 'Actif' : 'Inactif' }}
                </span>
              </td>

              <td class="actions-col">
                <button
                  mat-icon-button
                  color="primary"
                  type="button"
                  aria-label="Modifier"
                  (click)="editCompetence(competence); $event.stopPropagation()">
                  <mat-icon>edit</mat-icon>
                </button>

                <!-- Bouton toggle Activer / D√©sactiver la comp√©tence -->
                <button
                  mat-icon-button
                  [color]="competence.isActive ? 'warn' : 'primary'"
                  type="button"
                  (click)="toggleCompetenceActive(competence); $event.stopPropagation()"
                  [attr.aria-label]="competence.isActive ? 'D√©sactiver' : 'Activer'">
                  <mat-icon>
                    {{ competence.isActive ? 'toggle_off' : 'toggle_on' }}
                  </mat-icon>
                </button>

                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  aria-label="Supprimer"
                  (click)="deleteCompetence(competence); $event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>

            <tr *ngIf="!competenceLoading() && competences().length === 0">
              <td colspan="5" class="empty-state">
                <mat-icon>sentiment_dissatisfied</mat-icon>
                <p>Aucune comp√©tence d√©finie pour le moment.</p>
                <small>Ajoutez une comp√©tence avec le formulaire de gauche.</small>
              </td>
            </tr>
            </tbody>
          </table>

          <mat-paginator
            [length]="competenceTotal()"
            [pageIndex]="competencePageIndex()"
            [pageSize]="competencePageSize()"
            [pageSizeOptions]="[5, 10, 20]"
            (page)="competencePageChanged($event)">
          </mat-paginator>
        </div>
      </mat-card>

      <mat-card class="panel domain-detail" *ngIf="selectedCompetence() as competence">
        <header class="panel__header">
          <div>
            <h2>{{ competence.name }}</h2>
            <p>
              {{
                competence.description ||
                'Aucune description renseign√©e pour cette comp√©tence.'
              }}
            </p>
          </div>
          <button
            mat-icon-button
            color="primary"
            type="button"
            aria-label="Modifier cette comp√©tence"
            (click)="editCompetence(competence)">
            <mat-icon>edit</mat-icon>
          </button>
        </header>

        <div class="domain-detail__body">
          <p class="domain-detail__meta">
            Cr√©√©e le {{ formatDomainDate(competence.createdAt) }}
            <span *ngIf="competence.updatedAt">
              ¬∑ Mise √† jour le {{ formatDomainDate(competence.updatedAt) }}
            </span>
          </p>
        </div>
      </mat-card>
    </div>
  </div>
</section>
