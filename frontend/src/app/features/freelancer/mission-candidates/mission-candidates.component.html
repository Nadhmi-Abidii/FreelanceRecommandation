<section class="mission-candidates">
  <header class="hero">
    <div class="hero__meta">
      <p class="eyebrow">Mission dashboard</p>
      <h1>{{ mission()?.title || 'Mission' }}</h1>
      <div class="hero__chips">
        <span class="chip chip--primary">{{ mission()?.statusLabel }}</span>
        <span class="chip chip--soft">{{ mission()?.domaine }}</span>
        <span class="chip chip--muted">Budget {{ mission()?.budgetLabel }}</span>
        <span class="chip chip--muted">Echeance {{ mission()?.deadlineLabel }}</span>
      </div>
    </div>
    <div class="hero__actions">
      <a mat-stroked-button color="primary" routerLink="/missions">
        <mat-icon>arrow_back</mat-icon>
        Retour missions
      </a>
      <button mat-flat-button color="primary" type="button" (click)="reloadCurrent()">
        <mat-icon>refresh</mat-icon>
        Rafraichir
      </button>
    </div>
  </header>

  <div class="grid">
    <aside class="panel panel--candidates">
      <div class="panel__head">
        <div>
          <p class="eyebrow">Freelancers</p>
          <h2>Candidatures recues</h2>
        </div>
        <span class="pill">{{ candidates().length }} profil{{ candidates().length > 1 ? 's' : '' }}</span>
      </div>

      <div class="recommendations">
        <div class="recommendations__head">
          <div>
            <p class="eyebrow">AI</p>
            <h3>Suggestions de profils</h3>
          </div>
        </div>

        <mat-progress-bar *ngIf="loadingRecommendations()" mode="indeterminate"></mat-progress-bar>

        <div class="recommendations__error" *ngIf="recommendationsError()">
          <mat-icon>error_outline</mat-icon>
          <span>{{ recommendationsError() }}</span>
        </div>

        <div class="recommendations__empty" *ngIf="!loadingRecommendations() && !recommendations().length">
          <span>Aucune suggestion pour le moment.</span>
        </div>

        <div class="recommendations__list" *ngIf="recommendationCards().length">
          <div class="recommendation" *ngFor="let rec of recommendationCards()">
            <div>
              <strong>{{ rec.freelancerName || 'Freelancer' }}</strong>
              <p class="muted">{{ rec.title || 'Profil' }}</p>
            </div>
            <div class="recommendation__meta">
              <span class="recommendation__badge" [ngClass]="'recommendation__badge--' + rec.badgeTone">
                {{ rec.badgeLabel }}
              </span>
              <span class="recommendation__chip" *ngIf="rec.scorePercent != null">
                Score {{ rec.scorePercent }}%
              </span>
              <span class="muted" *ngIf="rec.reason">{{ rec.reason }}</span>
            </div>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <mat-progress-bar *ngIf="loadingCandidates()" mode="indeterminate"></mat-progress-bar>

      <div class="panel__error" *ngIf="error()">
        <mat-icon>error_outline</mat-icon>
        <span>{{ error() }}</span>
      </div>

      <div class="empty" *ngIf="!loadingCandidates() && !error() && !candidates().length">
        <mat-icon>person_search</mat-icon>
        <p>Aucune candidature pour le moment.</p>
      </div>

      <article
        class="candidate-card"
        *ngFor="let candidate of candidates()"
        [class.is-active]="candidate.id === selectedId()"
        (click)="selectCandidate(candidate.id)"
      >
        <div class="candidate-card__top">
          <div class="avatar">{{ candidate.name.slice(0, 1) }}</div>
          <div class="candidate-card__info">
            <h3>{{ candidate.name }}</h3>
            <p>{{ candidate.title }}</p>
            <p class="muted">{{ candidate.location }}</p>
          </div>
          <span class="status" [ngClass]="candidate.tone">{{ candidate.statusLabel }}</span>
        </div>
        <p class="preview" *ngIf="candidate.lastMessagePreview">
          {{ candidate.lastMessagePreview }}
        </p>
      </article>
    </aside>

    <section class="panel panel--conversation">
      <ng-container *ngIf="selectedCandidate() as candidate; else emptyState">
        <div class="conversation__head">
          <div>
            <p class="eyebrow">Conversation</p>
            <h2>{{ candidate.name }}</h2>
            <div class="contact">
              <span *ngIf="candidate.email"><mat-icon>mail</mat-icon>{{ candidate.email }}</span>
              <span *ngIf="candidate.phone"><mat-icon>call</mat-icon>{{ candidate.phone }}</span>
              <a *ngIf="candidate.resumeUrl" [href]="candidate.resumeUrl" target="_blank" rel="noopener">
                <mat-icon>attach_file</mat-icon>CV / portfolio
              </a>
            </div>
          </div>
          <span class="status status--pill" [ngClass]="candidate.tone">{{ candidate.statusLabel }}</span>
        </div>

        <mat-progress-bar *ngIf="loadingConversation()" mode="indeterminate"></mat-progress-bar>

        <div class="conversation__body" *ngIf="!loadingConversation()">
          <div
            class="bubble"
            *ngFor="let message of conversation()"
            [class.is-client]="message.sender === 'client'"
          >
            <div class="bubble__meta">
              <span>{{ message.authorLabel }}</span>
              <time>{{ message.sentAt | date: 'dd MMM HH:mm' }}</time>
            </div>
            <p>{{ message.content }}</p>
            <div class="bubble__flag" *ngIf="message.isFlagged">
              <mat-icon>report</mat-icon>
              <span>{{ message.flagLabel || 'Flagged content' }}</span>
            </div>
            <a *ngIf="message.resumeUrl" [href]="message.resumeUrl" target="_blank" rel="noopener">
              <mat-icon>open_in_new</mat-icon>
              Voir la piece jointe
            </a>
          </div>
        </div>

        <form class="composer" [formGroup]="messageForm" (ngSubmit)="sendMessage()">
          <mat-form-field appearance="outline" class="composer__field">
            <mat-label>Message au freelancer</mat-label>
            <textarea
              matInput
              rows="3"
              formControlName="content"
              placeholder="Partagez le scope, les attentes ou proposez un point."
            ></textarea>
            <mat-error *ngIf="messageForm.controls.content.hasError('required')">
              Message requis.
            </mat-error>
            <mat-error *ngIf="messageForm.controls.content.hasError('minlength')">
              3 caracteres minimum.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="composer__field">
            <mat-label>Lien de piece jointe (optionnel)</mat-label>
            <input matInput formControlName="resumeUrl" placeholder="https://...">
            <mat-error *ngIf="messageForm.controls.resumeUrl.invalid">
              Fournissez une URL valide.
            </mat-error>
          </mat-form-field>

          <div class="composer__actions">
            <button mat-stroked-button type="button" (click)="reloadConversation()" [disabled]="loadingConversation()">
              <mat-icon>refresh</mat-icon>
              Actualiser
            </button>
            <span class="spacer"></span>
            <button mat-flat-button color="primary" type="submit" [disabled]="messageForm.invalid || loadingConversation()">
              <mat-icon>send</mat-icon>
              Envoyer
            </button>
          </div>
        </form>
      </ng-container>

      <ng-template #emptyState>
        <div class="empty empty--center">
          <mat-icon>chat_bubble_outline</mat-icon>
          <p>Choisissez un candidat pour voir l'historique.</p>
        </div>
      </ng-template>
    </section>
  </div>
</section>
